# @sap/cds-odata-v2-adapter-proxy

[CDS OData V2 Adapter Proxy](https://www.npmjs.com/package/@sap/cds-odata-v2-adapter-proxy) for [CDS OData V4 Services](<(https://www.npmjs.com/package/@sap/cds)>)

Based on the [SAP Cloud Application Programming Model (CAP)](https://cap.cloud.sap/docs/)
using Node.js module [@sap/cds](https://www.npmjs.com/package/@sap/cds).

## Getting Started

- Install: `npm install @sap/cds-odata-v2-adapter-proxy`
- Unit Tests: `npm test`
- Test Server: `npm start`
  - Service: `http://localhost:4004/v2/main`
  - Metadata: `http://localhost:4004/v2/main/$metadata`
  - Data: `http://localhost:4004/v2/main/Header?$expand=Items`

## Usage

### CDS Combined Backend (Node.js) - Integrated

In your existing `@sap/cds` project:

- Run `npm install @sap/cds-odata-v2-adapter-proxy -s`
- Create new file `server.js` in the service folder `srv` of your project: `./srv/server.js`

```
"use strict";

const cds = require("@sap/cds");
const proxy = require("@sap/cds-odata-v2-adapter-proxy");

cds.on("bootstrap", app => app.use(proxy()));

module.exports = cds.server;
```

- Run `cds run` from the project root to start the server:
  - OData V2 service will be available at http://localhost:4004/v2/<service-path>
  - OData V4 service will be available at http://localhost:4004/<service-path>

Note that `@sap/cds` and `express` are peer dependency and needs to be available as module as well.

### CDS Combined Backend (Node.js) - Custom

In your existing `@sap/cds` project:

- Run `npm install @sap/cds-odata-v2-adapter-proxy -s`
- Create new file `index.js` in the service folder `srv` of your project: `./srv/index.js`

```
"use strict";

const express = require("express");
const cds = require("@sap/cds");
const proxy = require("@sap/cds-odata-v2-adapter-proxy");

const host = "0.0.0.0";
const port = process.env.PORT || 4004;

(async () => {
  const app = express();

  // serve odata v4
  await cds
    .connect("db")
    .serve("all")
    .in(app);

  // serve odata v2
  app.use(proxy({
    path: "v2",
    port: port
  }));

  // start server
  const server = app.listen(port, host, () => console.info(`app is listing at ${host}:${port}`));
  server.on("error", error => console.error(error.stack));
})();
```

- Run `node srv/index` from the project root to start the server:
  - OData V2 service will be available at http://localhost:4004/v2/<service-path>
  - OData V4 service will be available at http://localhost:4004/<service-path>

Note that `@sap/cds` and `express` are peer dependency and needs to be available as module as well.

### CDS Standalone Backend (for example, Java)

In a new Node.js express project:

- Run `npm install @sap/cds -s`
- Run `npm install @sap/cds-odata-v2-adapter-proxy -s`
- Place CDS models in `db` and `srv` model folders
- Create a new file `index.js` in the service folder `srv` of the project: `./srv/index.js`

```
"use strict";

const express = require("express");
const http = require("http");

const proxy = require("@sap/cds-odata-v2-adapter-proxy");

const host = "0.0.0.0";
const port = process.env.PORT || 4004;

(async () => {
  const app = express();

  // serve odata v2
  app.use(proxy({
    path: "v2",
    target: "http://localhost:8080",
    services: {
      "<odata-v4-service-path>": "<qualified.ServiceName>"
    }
  }));

  // start server
  const server = app.listen(port, host, () => console.info(`app is listing at ${host}:${port}`));
  server.on("error", error => console.error(error.stack));
})();
```

- In proxy option `services`, every OData V4 service URL path needs to mapped to
  the corresponding fully qualified CDS service name, e.g. `"/odata/v4/MainService/": "test.MainService"`,
  to establish the back-link connection between OData URL and its CDS service.
- Make sure, that your CDS models are also available in the project.
  Those reside either in `db` and `srv` folders, or a compiled (untransformed) `srv.json` is provided.
  This can be generated by using the following command:

  ```
  cds srv -s all -o .
  ```

- Alternatively, a `cds build` can be triggered as described in section "Cloud Foundry Deployment".
- If not detected automatically, the model path can be set with option `model` (especially if `srv.json` option is used).
- Make sure, that all i18n property files reside next to the `srv.json` in a `i18n` or `_i18n` folder, to be detected by localization.
- Run `node srv/index` from the project root to start the server:
  - OData V2 service will be available at http://localhost:4004/v2/<odata-v4-service-path>
  - OData V4 service shall be available at http://localhost:8080/<odata-v4-service-path>
- A deployed version of OData V2 proxy shall have option `target` set to the deployed OData V4 backend URL.
  This can be retrieved from the Cloud Foundry environment using `process.env`, for example,
  from the `destinations` environment variable.

Note that `@sap/cds` and `express` are peer dependency and needs to be available as module as well.

## Cloud Foundry Deployment

When deploying the CDS OData V2 Adapter Proxy to Cloud Foundry, make sure that it has access to the whole CDS model.
Especially, it’s the case, that normally the Node.js server is only based on folder `srv` and folder `db` is then missing on Cloud Foundry.

To come around this situation, trigger a `cds build` during development time, that generates a `csn.json` at location `gen/srv/srv/csn.json`.
Point your Cloud Foundry deployment of the CDS OData V2 Adapter Proxy to the folder `gen/srv` (using manifest.json or MTA), so that
the CDS models can be found via file `srv/csn.json`, during runtime execution on Cloud Foundry.

## SAP Fiori Elements V2

The OData V2 service provided by the CDS OData V2 Adapter Proxy can be used to serve an SAP Fiori Elements V2 UI.
A running example can be tested as follows:

- Start server: `npm run cds:run`
- Open Fiori Launchpad: http://localhost:4004/webapp/test/flpSandbox.html

## Documentation

Instantiates a CDS OData V2 Adapter Proxy Express Router for a CDS-based OData V4 Server

- **options:** CDS OData V2 Adapter Proxy options
  - **[options.base]:** Base path under which the service is reachable. Default is ''.
  - **[options.path]:** Path under which the proxy is reachable. Default is 'v2'.
  - **[options.model]:** CDS service model (path(s) or CSN). Default is 'all'.
  - **[options.port]:** Target port, which points to OData V4 backend port. Default is '4004'.
  - **[options.target]:** Target, which points to OData V4 backend host/port. Default is 'http://localhost:4004'.
  - **[options.targetPath]:** Target path to which is redirected. Default is ''.
  - **[options.services]:** Service mapping from url path name to service name. If omitted local CDS defaults apply.
  - **[options.standalone]:** Indication that OData V2 Adapter proxy is a standalone process. Default is 'false'.
  - **[options.mtxEndpoint]:** Endpoint to retrieve MTX metadata for standalone proxy. Default is '/mtx/v1'
  - **[options.ieee754Compatible]:** `Edm.Decimal` and `Edm.Int64` are serialized IEEE754 compatible. Default is 'true'.
  - **[options.disableNetworkLog]:** Disable networking logging. Default is 'true'.

## Logging

Logging is controlled with environment variable `XS_APP_LOG_LEVEL`. Especially, proxy requests and proxy responses
including url and body adaptations can be traced using `XS_APP_LOG_LEVEL=debug`.
Details can be found at [@sap/logging](https://www.npmjs.com/package/@sap/logging).

## Features

- GET, POST, PUT/PATCH, DELETE
- Batch support
- Actions, Functions
- Analytical Annotations
- Deep Expands/Selects
- JSON format
- Deep Structures
- Data Type Mapping (incl. Date Time)
- IEEE754Compatible
- Messages/Error Handling
- Location Header
- $inlinecount / $count / \$value
- Entity with Parameters
- Stream Support (Octet and Url), Content Disposition
- Multitenancy, Extensibility (proxy in same process only)
- Content-ID
- Draft Support
- Search Support
- Localization
- Temporal Data
- Tracing Support
- Logging Correlation
- ETag Support (Concurrency Control)

## OData V2/V4 Delta

[What’s New in OData Version 4.0](http://docs.oasis-open.org/odata/new-in-odata/v4.0/cn01/new-in-odata-v4.0-cn01.html)

## License

This package is provided under the terms of the [SAP Developer License Agreement](https://tools.hana.ondemand.com/developer-license-3.1.txt).
